import { ChartType, } from "@allurereport/charts-api";
import { DEFAULT_ENVIRONMENT } from "@allurereport/core-api";
import { generateCurrentStatusChart } from "./generateCurrentStatusChart.js";
import { generateDurationDynamicsChart } from "./generateDurationDynamicsChart.js";
import { generateDurationsChart } from "./generateDurationsChart.js";
import { generateFBSUAgePyramid } from "./generateFBSUAgePyramid.js";
import { generateStabilityDistributionChart } from "./generateStabilityDistributionChart.js";
import { generateStatusDynamicsChart } from "./generateStatusDynamicsChart.js";
import { generateStatusTransitionsChart } from "./generateStatusTransitionsChart.js";
import { generateTestBaseGrowthDynamicsChart } from "./generateTestBaseGrowthDynamicsChart.js";
import { generateTestingPyramidChart } from "./generateTestingPyramidChart.js";
import { generateTrSeveritiesChart } from "./generateTrSeveritiesChart.js";
import { generateHeatMapChart } from "./heatMap.js";
import { generateTreeMapChart } from "./treeMap.js";
const generateChartData = async (props) => {
    const { env, chartsOptions, store, reportName, generateUuid } = props;
    const result = {};
    const storeData = await Promise.all([
        env ? await store.allHistoryDataPointsByEnvironment(env) : await store.allHistoryDataPoints(),
        env ? await store.testResultsByEnvironment(env) : await store.allTestResults(),
        env ? await store.testsStatistic((tr) => tr.environment === env) : await store.testsStatistic(),
    ]).then(([historyDataPoints, testResults, statistic]) => ({
        historyDataPoints,
        testResults,
        statistic,
    }));
    for (const chartOption of chartsOptions) {
        const chartId = generateUuid();
        switch (chartOption.type) {
            case ChartType.CurrentStatus:
                result[chartId] = generateCurrentStatusChart(chartOption, storeData);
                break;
            case ChartType.StatusDynamics:
                result[chartId] = generateStatusDynamicsChart({ options: chartOption, storeData });
                break;
            case ChartType.StatusTransitions:
                result[chartId] = generateStatusTransitionsChart({ options: chartOption, storeData });
                break;
            case ChartType.Durations:
                result[chartId] = generateDurationsChart({ options: chartOption, storeData });
                break;
            case ChartType.DurationDynamics:
                result[chartId] = generateDurationDynamicsChart({ options: chartOption, storeData });
                break;
            case ChartType.StabilityDistribution:
                result[chartId] = generateStabilityDistributionChart({ options: chartOption, storeData });
                break;
            case ChartType.TestBaseGrowthDynamics:
                result[chartId] = generateTestBaseGrowthDynamicsChart({ options: chartOption, storeData });
                break;
            case ChartType.FBSUAgePyramid:
                result[chartId] = generateFBSUAgePyramid({ options: chartOption, storeData });
                break;
            case ChartType.TrSeverities:
                result[chartId] = generateTrSeveritiesChart({ options: chartOption, storeData });
                break;
            case ChartType.CoverageDiff:
                result[chartId] = generateTreeMapChart(chartOption, storeData);
                break;
            case ChartType.SuccessRateDistribution:
                result[chartId] = generateTreeMapChart(chartOption, storeData);
                break;
            case ChartType.ProblemsDistribution:
                result[chartId] = generateHeatMapChart(chartOption, storeData);
                break;
            case ChartType.TestingPyramid:
                result[chartId] = generateTestingPyramidChart(chartOption, storeData);
                break;
            default:
                break;
        }
    }
    return result;
};
const hasOnlyDefaultEnvironment = (environments) => {
    return environments.length === 1 && environments[0] === DEFAULT_ENVIRONMENT;
};
export const generateCharts = async (chartsOptions, store, reportName, generateUuid) => {
    const environments = await store.allEnvironments();
    const chartsData = {
        general: await generateChartData({ chartsOptions, store, reportName, generateUuid }),
        byEnv: {},
    };
    if (hasOnlyDefaultEnvironment(environments)) {
        return chartsData;
    }
    for (const environment of environments) {
        chartsData.byEnv[environment] = await generateChartData({
            chartsOptions,
            store,
            reportName,
            env: environment,
            generateUuid,
        });
    }
    return chartsData;
};
